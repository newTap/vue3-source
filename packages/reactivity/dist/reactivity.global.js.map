{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/index.ts"],"sourcesContent":["export const isObject =  (value:unknown) => typeof value === 'object' && value !== null","import { isObject } from \"@vue/shared\";\n// 使用WeakMap存储代理对象\n// WeakMap的键是弱引用，不会影响垃圾回收\nconst reactiveMap = new WeakMap();\n/**\n * reactive\n *\n * [export description]\n *\n * 响应式转换是\"成层\"的: 他会影响到所有嵌套的属性。\n *\n * \"深层\"次的响应代理\n *\n * @param   {T}          data  [需要代理的对象]\n *\n * @return  {<T><data>}        [返回一个对象的响应式代理。]\n */\nexport function reactive<T extends object>(data:T){\n  return createReactiveObject(data)\n} \n/**\n * [export description]\n *\n * 只读代理是深层的：对任何嵌套属性的访问都将是只读的\n *\n * \"深层\"次的响应代理，只读\n *\n * @param   {T}          data  [接受一个对象 (不论是响应式还是普通的) 或是一个 ref，]\n *\n * @return  {<T><data>}        [return 返回一个原值的只读代理]\n */\nexport function readonly<T extends object>(data:T){\n  return createReactiveObject(data, true)\n}\n\n/**\n * [export description]\n *\n * reactive() 的浅层作用形式。\n * 这里没有深层级的转换：一个浅层响应式对象里只有根级别的属性是响应式的。属性的值会被原样存储和暴露\n *\n * \"浅层\"次的响应代理\n *\n * @param   {T}          data  [data 需要代理的对象]\n *\n * @return  {<T><data>}        [return 一个没有深度代理的响应对象]\n */\nexport function shallowReactive<T extends object>(data:T){\n  return createReactiveObject(data, true, false)\n}\n\nexport function shallowReadonly<T extends object>(data:T){\n  return createReactiveObject(data, true, false)\n}\n\n/**\n * [createReactiveObject description]\n *\n * @param   {T}  data        [监听的数据对象]\n * @param   {[type]}isReadonly  [是否只读]\n * @param   {[type]}isShallow   [是否深层代理]\n *\n * @return  {T}              [return 数据的代理对象]\n */\nfunction createReactiveObject<T extends object>(data:T, isReadonly=false, isShallow=true):T {\n  // 非对象类型直接返回\n  if(!isObject(data)) {\n    console.error('请给一个对象')\n    return data;\n  }\n  // 校验是否已有代理对象\n  if(reactiveMap.has(data)) return reactiveMap.get(data);\n  // 若目标已经是一个代理对象，则需要返回该对象 待完善\n\n  const proxy =  new Proxy(data, {\n    set: function(target, value, receiver) {\n      console.log(`set: `, value, isReadonly)\n      if(isReadonly) {\n        throw new Error(\"该对象是只读无法修改属性\")\n      }\n      return Reflect.set(target, value, receiver)\n    },\n    get: function(target, key, receiver){\n      console.log(`get: ${key as string}`)\n      const res = Reflect.get(target, key, receiver)\n      // 递归处理,为了实现深层次的响应式\n      //! 只有调用到了get方法，才会进行递归，并没有将所有的子对象递归。属于优化\n      if(isShallow && isObject(res)) {\n        console.log('调用递归', isReadonly)\n        // !保证返回的对象是一个代理对象\n        // !否则在第一次进行set操作的时候，会导致无法监听到set的操作\n        return isReadonly? readonly(res as object) : reactive(res as object)\n      }\n      return res\n    }\n  });\n  reactiveMap.set(data, proxy)\n  return proxy\n}"],"names":[],"mappings":";;;EAAO,MAAM,QAAQ,GAAI,CAAC,KAAa,KAAK,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,KAAK,IAAI;;ECCvF;EACA;EACA,MAAM,WAAW,GAAG,IAAI,OAAO,EAAE,CAAC;EAClC;;;;;;;;;;;;EAYG;EACG,SAAU,QAAQ,CAAmB,IAAM,EAAA;EAC/C,IAAA,OAAO,oBAAoB,CAAC,IAAI,CAAC,CAAA;EACnC,CAAC;EACD;;;;;;;;;;EAUG;EACG,SAAU,QAAQ,CAAmB,IAAM,EAAA;EAC/C,IAAA,OAAO,oBAAoB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAA;EACzC,CAAC;EAED;;;;;;;;;;;EAWG;EACG,SAAU,eAAe,CAAmB,IAAM,EAAA;MACtD,OAAO,oBAAoB,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,CAAC,CAAA;EAChD,CAAC;EAEK,SAAU,eAAe,CAAmB,IAAM,EAAA;MACtD,OAAO,oBAAoB,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,CAAC,CAAA;EAChD,CAAC;EAED;;;;;;;;EAQG;EACH,SAAS,oBAAoB,CAAmB,IAAM,EAAE,UAAU,GAAC,KAAK,EAAE,SAAS,GAAC,IAAI,EAAA;;EAEtF,IAAA,IAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE;EAClB,QAAA,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAA;EACvB,QAAA,OAAO,IAAI,CAAC;OACb;;EAED,IAAA,IAAG,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC;EAAE,QAAA,OAAO,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;;EAGvD,IAAA,MAAM,KAAK,GAAI,IAAI,KAAK,CAAC,IAAI,EAAE;EAC7B,QAAA,GAAG,EAAE,UAAS,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAA;cACnC,OAAO,CAAC,GAAG,CAAC,CAAA,KAAA,CAAO,EAAE,KAAK,EAAE,UAAU,CAAC,CAAA;cACvC,IAAG,UAAU,EAAE;EACb,gBAAA,MAAM,IAAI,KAAK,CAAC,cAAc,CAAC,CAAA;eAChC;cACD,OAAO,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAA;WAC5C;EACD,QAAA,GAAG,EAAE,UAAS,MAAM,EAAE,GAAG,EAAE,QAAQ,EAAA;EACjC,YAAA,OAAO,CAAC,GAAG,CAAC,QAAQ,GAAa,CAAA,CAAE,CAAC,CAAA;EACpC,YAAA,MAAM,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,GAAG,EAAE,QAAQ,CAAC,CAAA;;;EAG9C,YAAA,IAAG,SAAS,IAAI,QAAQ,CAAC,GAAG,CAAC,EAAE;EAC7B,gBAAA,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,UAAU,CAAC,CAAA;;;EAG/B,gBAAA,OAAO,UAAU,GAAE,QAAQ,CAAC,GAAa,CAAC,GAAG,QAAQ,CAAC,GAAa,CAAC,CAAA;eACrE;EACD,YAAA,OAAO,GAAG,CAAA;WACX;EACF,KAAA,CAAC,CAAC;EACH,IAAA,WAAW,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;EAC5B,IAAA,OAAO,KAAK,CAAA;EACd;;;;;;;;;;;;;"}
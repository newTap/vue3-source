{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/constants.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject =  (value:unknown) => typeof value === 'object' && value !== null\n\nexport const isArray = Array.isArray","import { TrackOpTypes } from \"./constants\";\n\ntype EffectOptions = {\n lazy?: false\n}\n\ntype ActiveEffectType= () => void\nlet uid = 0;\n// 用于记录当前正在执行的副作用函数\nlet activeEffect: ActiveEffectType;\n// 用户基于当前正在执行的副作用函数队列\n// !如果不适用队列形式存储，会导致effect嵌套时，activeEffect无法被正确获取\n// effect(function () {\n//   let name = proxy.name\n//   effect(function () {\n//     let name = proxy.name\n//   })\n//   let list = proxy.list\n// })\nlet activeEffectPool: ActiveEffectType[] = []\n\n// 副作用函数的触发\nexport function effect (fn: () => void, options?: EffectOptions){\n  console.log('触发依赖')\n  const effectFn = function reactiveEffect(){\n    // 防止effect函数的的报错，对代码逻辑的影响\n    try{\n      activeEffect = fn\n      activeEffectPool.push(activeEffect)\n      fn()\n    }finally{\n      activeEffectPool.pop()\n      activeEffect = activeEffectPool[activeEffectPool.length - 1]\n    }\n  }\n \n  effectFn.fn = fn // 保存用户的原方法\n  effectFn.options = options // 保存用户的原配置\n  effectFn.id = uid++ // effect 的ID\n  effectFn._isEffect = true // 标记是否为 effect\n  if(!options?.lazy) fn();\n  return effectFn\n}\n\n// 用于存储依赖的集合\nconst targetActiveMap = new WeakMap()\n// 依赖的收集\nexport function track(target:object, key: string | symbol, type: TrackOpTypes){\n  console.log('开始收集依赖')\n  // 只有在副作用函数调用期间才做依赖的收集\n  if(!activeEffectPool.length) return false\n\n  // 依赖集合的数据结构，第一层使用WeakMap，利用它的弱引用\n  // target作为key值，依赖集合作为value值\n  let targetMap = targetActiveMap.get(target)\n  if(!targetMap) targetActiveMap.set(target, (targetMap = new Map()))\n  // 第二层使用Map数据结构\n  // key作为key值，依赖集合作为value值\n  let dep = targetMap.get(key)\n  // 第三层使用Set数据结构,当相同数据添加值set中会做自动去重操作\n  // 用于存放对应的副作用函数\n  if(!dep) targetMap.set(key, (dep = new Set()))\n\n  // 为对应的key添加副作用函数\n  dep.add(activeEffectPool[activeEffectPool.length-1])\n}","export enum TrackOpTypes {\n  GET = 'get',\n  HAS = 'has',\n}","import { isArray, isObject } from \"@vue/shared\"\nimport { reactive, readonly } from \"./reactive\"\nimport { track } from \"./effect\"\nimport { TrackOpTypes } from \"./constants\"\n\nconst get = createGetter()\nconst readonlyGet = createGetter(true)\nconst shallowReactiveGet = createGetter(false, true)\nconst shallowReadonlyGet = createGetter(true, true)\n\nconst set = createSetter()\nconst shallowSet = createSetter(true)\n\nexport const reactiveHandler = {\n  get,\n  set\n}\n\nexport const readonlyHandler = {\n get: readonlyGet,\n set: function(){\n  console.error('只读无法修改')\n  return false\n }\n}\n\nexport const shallowReactiveHandler = {\n  get: shallowReactiveGet,\n  set: shallowSet\n}\n\nexport const shallowReadonlyHandler = {\n  get: shallowReadonlyGet,\n  set: function(){\n   console.error('只读无法修改')\n   return false\n  }\n}\n\nfunction createGetter(isReadonly = false, isShallow = false) {\n  return function get (target: object, key:string|symbol, receiver: object) {\n      console.log(`get: ${key as string}`)\n      const res = Reflect.get(target, key, receiver)\n      // 收集 effect\n      if(!isReadonly){\n        console.log('收集 effect')\n        track(target, key, TrackOpTypes.GET)\n      }\n      // 递归处理,为了实现深层次的响应式\n      //! 只有调用到了get方法，才会进行递归，并没有将所有的子对象递归。属于优化\n      if(!isShallow && isObject(res)) {\n        console.log('调用递归', res)\n        // !保证返回的对象是一个代理对象\n        // !否则在第一次进行set操作的时候，会导致无法监听到set的操作\n        return isReadonly? readonly(res as object) : reactive(res as object)\n      }\n      return res\n    }\n}\n\nfunction createSetter(isShallow = false){\n  return function set(target:object, value:string | symbol, receiver:object) {\n      console.log(`set: `, value)\n      let ref = Reflect.set(target, value, receiver)\n      // 1.先处理数组and修改\n      if(isArray(target)){\n        \n      }\n      // 执行 effect\n      // 注意要区分  数组  与    对象\n      // 注意区分 添加   与    修改\n      return ref\n    }\n}","import { isObject } from \"@vue/shared\";\nimport { reactiveHandler, readonlyHandler, shallowReactiveHandler, shallowReadonlyHandler } from \"./baseHandlers\";\n\nexport type targetType<T> = T;\n// 使用WeakMap存储代理对象\n// WeakMap的键是弱引用，不会影响垃圾回收\nconst reactiveMap = new WeakMap();\nconst readonlyMap = new WeakMap();\n/**\n * reactive\n *\n * [export description]\n *\n * 响应式转换是\"成层\"的: 他会影响到所有嵌套的属性。\n *\n * \"深层\"次的响应代理\n *\n * @param   {T}          data  [需要代理的对象]\n *\n * @return  {<T><data>}        [返回一个对象的响应式代理。]\n */\nexport function reactive<T extends object>(data:T):object{\n  return createReactiveObject(data, false, false, reactiveHandler)\n} \n/**\n * [export description]\n *\n * 只读代理是深层的：对任何嵌套属性的访问都将是只读的\n *\n * \"深层\"次的响应代理，只读\n *\n * @param   {T}          data  [接受一个对象 (不论是响应式还是普通的) 或是一个 ref，]\n *\n * @return  {<T><data>}        [return 返回一个原值的只读代理]\n */\nexport function readonly<T extends object>(data:T):object{\n  return createReactiveObject(data, true , false, readonlyHandler)\n}\n\n/**\n * [export description]\n *\n * reactive() 的浅层作用形式。\n * 这里没有深层级的转换：一个浅层响应式对象里只有根级别的属性是响应式的。属性的值会被原样存储和暴露\n *\n * \"浅层\"次的响应代理\n *\n * @param   {T}          data  [data 需要代理的对象]\n *\n * @return  {<T><data>}        [return 一个没有深度代理的响应对象]\n */\nexport function shallowReactive<T extends object>(data:T):object{\n  return createReactiveObject(data, true, false, shallowReactiveHandler)\n}\n\nexport function shallowReadonly<T extends object>(data:T):object{\n  return createReactiveObject(data, true, false, shallowReadonlyHandler)\n}\n\n/**\n * [createReactiveObject description]\n *\n * @param   {T}  data        [监听的数据对象]\n * @param   {[type]}isReadonly  [是否只读]\n * @param   {[type]}isShallow   [是否深层代理]\n *\n * @return  {T}              [return 数据的代理对象]\n */\nfunction createReactiveObject<T extends object>(data:T, isReadonly=false, isShallow=true, handlers:ProxyHandler<T>):T {\n  // 非对象类型直接返回\n  if(!isObject(data)) {\n    console.error('请给一个对象')\n    return data;\n  }\n  const proxyMap = isReadonly ? readonlyMap : reactiveMap\n  // 校验是否已有代理对象\n  if(proxyMap.has(data)) return proxyMap.get(data);\n  // 若目标已经是一个代理对象，则需要返回该对象 待完善\n\n  const proxy =  new Proxy(data, handlers);\n  proxyMap.set(data, proxy)\n  return proxy\n}"],"names":[],"mappings":"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"}